Bootstrap: docker
From: nvidia/cuda:12.4.1-devel-ubuntu22.04

%labels
    Author VAGEN-Team
    Version vagen-lite-v1

%environment
    export DEBIAN_FRONTEND=noninteractive
    export PATH=/opt/conda/bin:$PATH
    export USE_MEGATRON=0
    export USE_SGLANG=1
    # Set cache dirs to writable locations if needed, or bind mount them
    export XDG_CACHE_HOME=/tmp/.cache

%post
    # 1. Install System Dependencies
    apt-get update && apt-get install -y \
        wget \
        git \
        build-essential \
        ffmpeg \
        libsm6 \
        libxext6 \
        ninja-build \
        && rm -rf /var/lib/apt/lists/*

    # 2. Install Miniconda (Python 3.12)
    wget https://repo.anaconda.com/miniconda/Miniconda3-latest-Linux-x86_64.sh -O miniconda.sh
    bash miniconda.sh -b -p /opt/conda
    rm miniconda.sh
    export PATH=/opt/conda/bin:$PATH

    # 3. Create Environment
    # We install into the base env for simplicity in the container
    conda install -y python=3.12 pip
    conda clean -ya

    # 4. Clone VAGEN (lite branch) to install dependencies
    # We use a temporary location to install dependencies defined in the repo
    mkdir -p /opt/build
    git clone https://github.com/mll-lab-nu/VAGEN.git /opt/build/vagen
    cd /opt/build/vagen
    git checkout vagen-lite
    git submodule update --init --recursive

    # 5. Install VAGEN dependencies
    pip install -e .

    # 6. Install VERL dependencies
    cd verl
    export USE_MEGATRON=0
    export USE_SGLANG=1
    bash scripts/install_vllm_sglang_mcore.sh
    
    # 7. Finalize VERL install
    pip install --no-deps -e .
    
    # 8. Install TRL
    pip install "trl==0.26.2"

    # Cleanup
    pip cache purge
    # We keep /opt/build/vagen because 'pip install -e .' links to it. 
    # If users bind mount their code, they should switch to that directory.
    
%runscript
    # Default command
    exec /bin/bash "$@"
